<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProveApp - Gesti√≥n de Proveedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        // ============================================
        // IMPORTAR FIREBASE M√ìDULOS ES
        // ============================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            doc, 
            deleteDoc, 
            onSnapshot, 
            where, 
            query, 
            orderBy, 
            limit 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ============================================
        // CONFIGURACI√ìN FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAMB9h7cNxaSiTbrjYfbHaA58QDgqbAayM",
            authDomain: "proveapp-35793.firebaseapp.com",
            projectId: "proveapp-35793",
            storageBucket: "proveapp-35793.firebasestorage.app",
            messagingSenderId: "734706343214",
            appId: "1:734706343214:web:c6acde37c1d491864a6ebf"
        };

        // ============================================
        // INICIALIZAR FIREBASE
        // ============================================
        console.log('üî• Inicializando Firebase...');
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log('‚úÖ Firebase inicializado correctamente');
            console.log('‚úÖ Firestore carg√≥');
            console.log('‚úÖ Conexi√≥n a DB: ‚úÖ');
            console.log('‚úÖ Config projectId:', firebaseConfig.projectId);

            // ============================================
            // ESTADO GLOBAL
            // ============================================
            let usuarioActual = null;
            let rolActual = null;
            let proveedorActual = null;
            let reservas = [];
            let proveedores = [];

            // ============================================
            // CARGAR DATOS DESDE FIREBASE
            // ============================================
            async function cargarProveedores() {
                try {
                    const snap = await getDocs(collection(db, 'proveedores'));
                    proveedores = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.log('‚úÖ Proveedores cargados:', proveedores.length);
                } catch (error) {
                    console.error('‚ùå Error cargando proveedores:', error);
                }
            }

            async function cargarReservasProveedor() {
                if (!proveedorActual) {
                    reservas = [];
                    actualizarUI();
                    return;
                }

                try {
                    const q = query(
                        collection(db, 'reservas'),
                        where('codigoProveedor', '==', proveedorActual),
                        orderBy('fecha', 'desc')
                    );
                    const snap = await getDocs(q);
                    reservas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.log('‚úÖ Reservas cargadas:', reservas.length);
                    actualizarUI();
                } catch (error) {
                    console.error('‚ùå Error cargando reservas:', error);
                    mostrarNotificacion('Error: ' + error.message, 'error');
                }
            }

            // Escuchar cambios en tiempo real
            onSnapshot(collection(db, 'proveedores'), () => { 
                cargarProveedores().then(() => { 
                    if (rolActual === 'admin') renderAdmin(); 
                }); 
            });

            onSnapshot(collection(db, 'reservas'), () => { 
                if (rolActual === 'proveedor') cargarReservasProveedor();
            });

            // ============================================
            // UTILIDADES
            // ============================================
            function generarCodigoProveedor() {
                const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let codigo = 'PROV-';
                for (let i = 0; i < 6; i++) {
                    codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
                }
                return codigo;
            }

            function mostrarNotificacion(msg, tipo) {
                const color = tipo === 'success' ? '#10b981' : '#ef4444';
                console.log((tipo === 'success' ? '‚úÖ' : '‚ùå'), msg);
                alert(msg);
            }

            // ============================================
            // RENDER LOGIN
            // ============================================
            function renderLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                        <div class="w-full max-w-md">
                            <div class="bg-white rounded-2xl shadow-2xl p-8">
                                <div class="text-center mb-8">
                                    <h1 class="text-4xl font-black mb-2">üî• ProveApp</h1>
                                    <p class="text-gray-600">Gesti√≥n de Proveedores con Firebase ‚úÖ</p>
                                </div>
                                
                                <div class="space-y-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">üë§ Usuario Admin:</label>
                                        <input type="text" id="usuario" value="admin" placeholder="admin" class="w-full p-3 border-2 rounded-lg font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-2">üîê Contrase√±a:</label>
                                        <input type="password" id="password" value="admin123" placeholder="admin123" class="w-full p-3 border-2 rounded-lg font-semibold">
                                    </div>
                                    <button onclick="doLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">
                                        ‚öôÔ∏è Acceder como Admin
                                    </button>
                                </div>

                                <div class="border-t pt-6">
                                    <p class="text-sm font-semibold text-gray-600 mb-3">üì± O ingresa c√≥digo de proveedor:</p>
                                    <div class="flex gap-2">
                                        <input type="text" id="codigoProveedor" placeholder="PROV-ABC123" class="flex-1 p-3 border-2 rounded-lg font-mono font-bold">
                                        <button onclick="loginProveedor()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700">
                                            ‚úì Acceder
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-6 text-white text-sm">
                                <p>Firebase Status: <strong>‚úÖ CONECTADO</strong></p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ============================================
            // LOGIN FUNCIONES
            // ============================================
            window.doLogin = function() {
                const usuario = document.getElementById('usuario').value;
                const password = document.getElementById('password').value;

                if (usuario === 'admin' && password === 'admin123') {
                    usuarioActual = 'ADMIN';
                    rolActual = 'admin';
                    cargarProveedores().then(() => renderAdmin());
                } else {
                    mostrarNotificacion('‚ùå Credenciales incorrectas', 'error');
                }
            };

            window.loginProveedor = async function() {
                const codigo = document.getElementById('codigoProveedor').value.trim();
                if (!codigo) {
                    mostrarNotificacion('‚ö†Ô∏è Ingresa tu c√≥digo', 'error');
                    return;
                }

                try {
                    const q = query(collection(db, 'proveedores'), where('codigo', '==', codigo), limit(1));
                    const snap = await getDocs(q);
                    
                    if (snap.empty) {
                        mostrarNotificacion('‚ùå C√≥digo no encontrado', 'error');
                        return;
                    }

                    const proveedor = snap.docs[0].data();
                    usuarioActual = proveedor.nombre;
                    proveedorActual = codigo;
                    rolActual = 'proveedor';
                    
                    await cargarReservasProveedor();
                    renderEmployee();
                } catch (error) {
                    mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
                }
            };

            window.logout = function() {
                if (confirm('¬øCerrar sesi√≥n?')) {
                    usuarioActual = null;
                    rolActual = null;
                    proveedorActual = null;
                    renderLogin();
                }
            };

            // ============================================
            // RENDER EMPLOYEE
            // ============================================
            function renderEmployee() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <div class="bg-blue-600 text-white p-4">
                            <div class="container mx-auto flex justify-between items-center">
                                <h1 class="text-2xl font-bold">üìÖ ProveApp</h1>
                                <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700 font-semibold">üö™ Salir</button>
                            </div>
                        </div>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="bg-blue-50 p-4 rounded-lg mb-6 border-2 border-blue-200">
                                    <p class="text-lg"><strong>üëã Bienvenido:</strong> ${usuarioActual}</p>
                                    <p class="text-sm text-gray-600 mt-2">C√≥digo: <code class="bg-white px-2 py-1 rounded font-bold">${proveedorActual}</code></p>
                                </div>

                                <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200">
                                    <h3 class="font-bold mb-3 text-lg">‚ûï Nueva Reserva</h3>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="text-sm font-semibold">Fecha:</label>
                                            <input type="date" id="formFecha" class="w-full p-2 border-2 rounded">
                                        </div>
                                        <div>
                                            <label class="text-sm font-semibold">Hora:</label>
                                            <input type="time" id="formHora" class="w-full p-2 border-2 rounded">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="text-sm font-semibold">Sal√≥n:</label>
                                            <input type="text" id="formSalon" placeholder="Principal" class="w-full p-2 border-2 rounded">
                                        </div>
                                        <div>
                                            <label class="text-sm font-semibold">Monto ($):</label>
                                            <input type="number" id="formMonto" placeholder="500" class="w-full p-2 border-2 rounded">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-semibold">Notas:</label>
                                        <textarea id="formNotas" placeholder="Detalles adicionales..." class="w-full p-2 border-2 rounded mb-3"></textarea>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="guardarReserva()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">üíæ Guardar</button>
                                        <button onclick="limpiarForm()" class="flex-1 bg-gray-400 text-white py-2 rounded font-bold hover:bg-gray-500">‚úï Limpiar</button>
                                    </div>
                                </div>

                                <h3 class="font-bold mb-3 text-lg">üìã Mis Reservas</h3>
                                <div id="reservasTable"></div>
                            </div>
                        </div>
                    </div>
                `;
                actualizarUI();
            }

            function actualizarUI() {
                const tbody = document.getElementById('reservasTable');
                if (!tbody) return;

                if (reservas.length === 0) {
                    tbody.innerHTML = '<div class="text-center py-8 text-gray-500">üì≠ Sin reservas creadas</div>';
                    return;
                }

                let html = `
                    <div class="border-2 rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left font-bold">Fecha</th>
                                    <th class="p-3 text-left font-bold">Hora</th>
                                    <th class="p-3 text-left font-bold">Sal√≥n</th>
                                    <th class="p-3 text-left font-bold">Monto</th>
                                    <th class="p-3 text-left font-bold">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                reservas.forEach((r, idx) => {
                    html += `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="p-3">${r.fecha || 'N/A'}</td>
                            <td class="p-3">${r.hora || 'N/A'}</td>
                            <td class="p-3">${r.salon || 'N/A'}</td>
                            <td class="p-3 font-semibold">$${r.monto || 0}</td>
                            <td class="p-3">
                                <button onclick="eliminarReserva('${r.id}')" class="text-red-600 hover:text-red-800 font-bold text-xl">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
                tbody.innerHTML = html;
            }

            window.guardarReserva = async function() {
                const fecha = document.getElementById('formFecha').value;
                const hora = document.getElementById('formHora').value;
                const salon = document.getElementById('formSalon').value;
                const monto = document.getElementById('formMonto').value;
                const notas = document.getElementById('formNotas').value;

                if (!fecha || !hora || !salon || !monto) {
                    mostrarNotificacion('‚ö†Ô∏è Completa todos los campos', 'error');
                    return;
                }

                try {
                    await addDoc(collection(db, 'reservas'), {
                        codigoProveedor: proveedorActual,
                        nombreProveedor: usuarioActual,
                        fecha,
                        hora,
                        salon,
                        monto,
                        notas,
                        estado: 'confirmada',
                        createdAt: new Date()
                    });
                    mostrarNotificacion('‚úÖ Reserva guardada en Firebase', 'success');
                    limpiarForm();
                    await cargarReservasProveedor();
                } catch (error) {
                    mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
                }
            };

            window.eliminarReserva = async function(id) {
                if (confirm('¬øEliminar esta reserva?')) {
                    try {
                        await deleteDoc(doc(db, 'reservas', id));
                        mostrarNotificacion('‚úÖ Reserva eliminada', 'success');
                        await cargarReservasProveedor();
                    } catch (error) {
                        mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
                    }
                }
            };

            window.limpiarForm = function() {
                document.getElementById('formFecha').value = '';
                document.getElementById('formHora').value = '';
                document.getElementById('formSalon').value = '';
                document.getElementById('formMonto').value = '';
                document.getElementById('formNotas').value = '';
            };

            // ============================================
            // RENDER ADMIN
            // ============================================
            function renderAdmin() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <div class="bg-blue-600 text-white p-4">
                            <div class="container mx-auto flex justify-between items-center">
                                <h1 class="text-2xl font-bold">‚öôÔ∏è Panel Admin</h1>
                                <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700 font-semibold">üö™ Salir</button>
                            </div>
                        </div>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="bg-blue-100 p-4 rounded-lg border-2 border-blue-300">
                                        <p class="text-sm font-semibold text-gray-600">Proveedores</p>
                                        <p class="text-4xl font-black text-blue-600">${proveedores.length}</p>
                                    </div>
                                    <div class="bg-purple-100 p-4 rounded-lg border-2 border-purple-300">
                                        <p class="text-sm font-semibold text-gray-600">Reservas</p>
                                        <p class="text-4xl font-black text-purple-600">${reservas.length}</p>
                                    </div>
                                    <div class="bg-green-100 p-4 rounded-lg border-2 border-green-300">
                                        <p class="text-sm font-semibold text-gray-600">Ingresos</p>
                                        <p class="text-3xl font-black text-green-600">$${reservas.reduce((s, r) => s + (parseFloat(r.monto) || 0), 0).toFixed(0)}</p>
                                    </div>
                                </div>

                                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
                                    <h3 class="font-bold mb-3 text-lg">‚ûï Crear Proveedor</h3>
                                    <div class="grid grid-cols-3 gap-3">
                                        <input type="text" id="provNombre" placeholder="Nombre" class="p-3 border-2 rounded-lg font-semibold">
                                        <input type="email" id="provEmail" placeholder="Email" class="p-3 border-2 rounded-lg font-semibold">
                                        <button onclick="crearProveedor()" class="bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">‚úì Crear</button>
                                    </div>
                                </div>

                                <h3 class="font-bold mb-3 text-lg">üë• Proveedores Registrados</h3>
                                <div id="proveedoresTable"></div>
                            </div>
                        </div>
                    </div>
                `;
                actualizarTablaProveedores();
            }

            window.crearProveedor = async function() {
                const nombre = document.getElementById('provNombre').value.trim();
                const email = document.getElementById('provEmail').value.trim();

                if (!nombre || !email) {
                    mostrarNotificacion('‚ö†Ô∏è Completa todos los campos', 'error');
                    return;
                }

                try {
                    const codigo = generarCodigoProveedor();
                    await addDoc(collection(db, 'proveedores'), {
                        nombre,
                        email,
                        codigo,
                        descripcion: '',
                        fechaCreacion: new Date()
                    });
                    mostrarNotificacion(`‚úÖ Proveedor creado\n\nC√≥digo: ${codigo}`, 'success');
                    document.getElementById('provNombre').value = '';
                    document.getElementById('provEmail').value = '';
                } catch (error) {
                    mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
                }
            };

            function actualizarTablaProveedores() {
                const tbody = document.getElementById('proveedoresTable');
                if (!tbody) return;

                let html = `
                    <div class="border-2 rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left font-bold">Nombre</th>
                                    <th class="p-3 text-left font-bold">C√≥digo</th>
                                    <th class="p-3 text-left font-bold">Email</th>
                                    <th class="p-3 text-left font-bold">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (proveedores.length === 0) {
                    html += '<tr><td colspan="4" class="p-4 text-center text-gray-500 font-semibold">üì≠ Sin proveedores</td></tr>';
                } else {
                    proveedores.forEach(p => {
                        html += `
                            <tr class="border-t hover:bg-gray-50">
                                <td class="p-3 font-semibold">${p.nombre}</td>
                                <td class="p-3"><code class="bg-yellow-100 px-3 py-1 rounded font-mono font-bold text-yellow-800">${p.codigo}</code></td>
                                <td class="p-3 text-sm text-gray-600">${p.email}</td>
                                <td class="p-3">
                                    <button onclick="eliminarProveedor('${p.id}')" class="text-red-600 hover:text-red-800 font-bold text-xl">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    });
                }

                html += '</tbody></table></div>';
                tbody.innerHTML = html;
            }

            window.eliminarProveedor = async function(id) {
                if (confirm('¬øEliminar este proveedor y todas sus reservas?')) {
                    try {
                        // Eliminar reservas del proveedor
                        const prov = proveedores.find(p => p.id === id);
                        if (prov) {
                            const q = query(collection(db, 'reservas'), where('codigoProveedor', '==', prov.codigo));
                            const snap = await getDocs(q);
                            for (const doc of snap.docs) {
                                await deleteDoc(doc.ref);
                            }
                        }
                        
                        // Eliminar proveedor
                        await deleteDoc(doc(db, 'proveedores', id));
                        mostrarNotificacion('‚úÖ Proveedor eliminado', 'success');
                    } catch (error) {
                        mostrarNotificacion('‚ùå Error: ' + error.message, 'error');
                    }
                }
            };

            // ============================================
            // INICIAR APP
            // ============================================
            console.log('üöÄ ProveApp iniciada - Firebase conectado ‚úÖ');
            renderLogin();

        } catch (error) {
            console.error('‚ùå Error en Firebase:', error);
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-red-100 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg p-8 max-w-md text-center shadow-lg">
                        <h2 class="text-2xl font-bold text-red-600 mb-4">‚ùå Error de Firebase</h2>
                        <p class="text-gray-700 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">
                            üîÑ Recargar
                        </button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
