<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProveApp - Gesti√≥n de Proveedores</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, onSnapshot, where, query, orderBy, limit, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Configuraci√≥n Firebase - REEMPLAZAR CON TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyAMB9h7cNxaSiTbrjYfbHaA58QDgqbAayM",
            authDomain: "proveapp-35793.firebaseapp.com",
            projectId: "proveapp-35793",
            storageBucket: "proveapp-35793.firebasestorage.app",
            messagingSenderId: "734706343214",
            appId: "1:734706343214:web:c6acde37c1d491864a6ebf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado global
        let usuarioActual = null;
        let rolActual = null;
        let proveedorActual = null;
        let reservas = [];
        let proveedores = [];
        let firebaseActivo = false;

        // Inicializar
        console.log('‚è≥ Inicializando Firebase...');
        try {
            console.log('‚úÖ Firebase inicializado correctamente');
            console.log('‚úÖ Firestore carg√≥');
            console.log('‚úÖ Conexi√≥n a DB: ‚úÖ');
            console.log('‚úÖ Config projectId:', firebaseConfig.projectId);
            firebaseActivo = true;
        } catch (error) {
            console.error('‚ùå Error Firebase:', error);
            firebaseActivo = false;
        }

        // Cargar datos desde Firebase
        async function cargarProveedores() {
            try {
                const snap = await getDocs(collection(db, 'proveedores'));
                proveedores = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log('‚úÖ Proveedores cargados:', proveedores.length);
            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }

        async function cargarReservasProveedor() {
            if (!firebaseActivo || !proveedorActual) {
                reservas = [];
                actualizarUI();
                return;
            }

            try {
                const q = query(
                    collection(db, 'reservas'),
                    where('codigoProveedor', '==', proveedorActual),
                    orderBy('fecha', 'desc')
                );
                const snap = await getDocs(q);
                reservas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log('‚úÖ Reservas cargadas:', reservas.length);
                actualizarUI();
            } catch (error) {
                console.error('Error cargando reservas:', error);
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        }

        // Escuchar cambios en tiempo real
        onSnapshot(collection(db, 'proveedores'), () => { 
            cargarProveedores().then(() => { 
                if (rolActual === 'admin') renderAdmin(); 
            }); 
        });

        onSnapshot(collection(db, 'reservas'), () => { 
            if (rolActual === 'proveedor') cargarReservasProveedor();
            if (rolActual === 'admin') cargarReservasProveedor();
        });

        // Utilidades
        function generarCodigoProveedor() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let codigo = 'PROV-';
            for (let i = 0; i < 6; i++) {
                codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return codigo;
        }

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // LOGIN
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
                    <div class="w-full max-w-md">
                        <div class="bg-white rounded-2xl shadow-2xl p-8">
                            <h1 class="text-3xl font-bold text-center mb-2">ProveApp</h1>
                            <p class="text-center text-gray-600 mb-8">Gesti√≥n de Proveedores con Firebase</p>
                            
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Usuario:</label>
                                    <input type="text" id="usuario" value="admin" placeholder="admin" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Contrase√±a:</label>
                                    <input type="password" id="password" value="admin123" placeholder="admin123" class="w-full p-3 border rounded-lg">
                                </div>
                                <button onclick="doLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                    Acceder (Admin)
                                </button>
                            </div>

                            <div class="mt-6 border-t pt-6">
                                <p class="text-sm text-gray-600 mb-3">O ingresa c√≥digo de proveedor:</p>
                                <div class="flex gap-2">
                                    <input type="text" id="codigoProveedor" placeholder="PROV-ABC123" class="flex-1 p-3 border rounded-lg">
                                    <button onclick="loginProveedor()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold">Login</button>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-6">
                            <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-lg px-6 py-3 inline-block">
                                <p class="text-white text-sm font-medium">
                                    ProveApp con Firebase ‚úÖ
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // LOGIN
        window.doLogin = function() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;

            if (usuario === 'admin' && password === 'admin123') {
                usuarioActual = 'ADMIN';
                rolActual = 'admin';
                cargarProveedores().then(() => renderAdmin());
            } else {
                mostrarNotificacion('Credenciales incorrectas', 'error');
            }
        };

        window.loginProveedor = async function() {
            const codigo = document.getElementById('codigoProveedor').value.trim();
            if (!codigo) {
                mostrarNotificacion('Ingresa tu c√≥digo', 'error');
                return;
            }

            try {
                const q = query(collection(db, 'proveedores'), where('codigo', '==', codigo), limit(1));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    mostrarNotificacion('C√≥digo no encontrado', 'error');
                    return;
                }

                const proveedor = snap.docs[0].data();
                usuarioActual = proveedor.nombre;
                proveedorActual = codigo;
                rolActual = 'proveedor';
                
                await cargarReservasProveedor();
                renderEmployee();
            } catch (error) {
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        };

        window.logout = function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                usuarioActual = null;
                rolActual = null;
                proveedorActual = null;
                renderLogin();
            }
        };

        // PANEL PROVEEDOR
        function renderEmployee() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-600 text-white p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold">ProveApp - √Årea Personal</h1>
                            <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700">üö™ Salir</button>
                        </div>
                    </div>
                    <div class="container mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-xl font-bold mb-4">üëã Bienvenido ${usuarioActual}</h2>
                            <p class="mb-4">C√≥digo: <strong>${proveedorActual}</strong></p>

                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 class="font-bold mb-3">‚ûï Crear Nueva Reserva</h3>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <input type="date" id="formFecha" class="p-2 border rounded">
                                    <input type="time" id="formHora" class="p-2 border rounded">
                                </div>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <input type="text" id="formSalon" placeholder="Sal√≥n" class="p-2 border rounded">
                                    <input type="number" id="formMonto" placeholder="Monto" class="p-2 border rounded">
                                </div>
                                <textarea id="formNotas" placeholder="Notas" class="w-full p-2 border rounded mb-3"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="guardarReserva()" class="flex-1 bg-green-600 text-white py-2 rounded">Guardar</button>
                                    <button onclick="limpiarForm()" class="flex-1 bg-gray-400 text-white py-2 rounded">Limpiar</button>
                                </div>
                            </div>

                            <h3 class="font-bold mb-3">üìã Mis Reservas</h3>
                            <div id="reservasTable"></div>
                        </div>
                    </div>
                </div>
            `;
            actualizarUI();
        }

        function actualizarUI() {
            const tbody = document.getElementById('reservasTable');
            if (!tbody) return;

            if (reservas.length === 0) {
                tbody.innerHTML = '<p class="text-gray-500 text-center py-4">Sin reservas</p>';
                return;
            }

            let html = `
                <div class="border rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">Fecha</th>
                                <th class="p-3 text-left">Hora</th>
                                <th class="p-3 text-left">Sal√≥n</th>
                                <th class="p-3 text-left">Monto</th>
                                <th class="p-3 text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            reservas.forEach((r, idx) => {
                html += `
                    <tr class="border-t">
                        <td class="p-3">${r.fecha || 'N/A'}</td>
                        <td class="p-3">${r.hora || 'N/A'}</td>
                        <td class="p-3">${r.salon || 'N/A'}</td>
                        <td class="p-3">$${r.monto || 0}</td>
                        <td class="p-3">
                            <button onclick="eliminarReserva('${r.id}')" class="text-red-600">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            tbody.innerHTML = html;
        }

        window.guardarReserva = async function() {
            const fecha = document.getElementById('formFecha').value;
            const hora = document.getElementById('formHora').value;
            const salon = document.getElementById('formSalon').value;
            const monto = document.getElementById('formMonto').value;
            const notas = document.getElementById('formNotas').value;

            if (!fecha || !hora || !salon || !monto) {
                mostrarNotificacion('Completa todos los campos', 'error');
                return;
            }

            try {
                await addDoc(collection(db, 'reservas'), {
                    codigoProveedor: proveedorActual,
                    fecha,
                    hora,
                    salon,
                    monto,
                    notas,
                    estado: 'confirmada',
                    createdAt: new Date()
                });
                mostrarNotificacion('‚úÖ Reserva guardada', 'success');
                limpiarForm();
                await cargarReservasProveedor();
            } catch (error) {
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        };

        window.eliminarReserva = async function(id) {
            if (confirm('¬øEliminar esta reserva?')) {
                try {
                    await deleteDoc(doc(db, 'reservas', id));
                    mostrarNotificacion('‚úÖ Eliminada', 'success');
                    await cargarReservasProveedor();
                } catch (error) {
                    mostrarNotificacion('Error: ' + error.message, 'error');
                }
            }
        };

        window.limpiarForm = function() {
            document.getElementById('formFecha').value = '';
            document.getElementById('formHora').value = '';
            document.getElementById('formSalon').value = '';
            document.getElementById('formMonto').value = '';
            document.getElementById('formNotas').value = '';
        };

        // PANEL ADMIN
        function renderAdmin() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <div class="bg-blue-600 text-white p-4">
                        <div class="container mx-auto flex justify-between items-center">
                            <h1 class="text-2xl font-bold">Panel Admin</h1>
                            <button onclick="logout()" class="px-4 py-2 rounded hover:bg-blue-700">üö™ Salir</button>
                        </div>
                    </div>
                    <div class="container mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-100 p-4 rounded">
                                    <p class="text-sm">Proveedores</p>
                                    <p class="text-3xl font-bold">${proveedores.length}</p>
                                </div>
                                <div class="bg-purple-100 p-4 rounded">
                                    <p class="text-sm">Reservas</p>
                                    <p class="text-3xl font-bold">${reservas.length}</p>
                                </div>
                                <div class="bg-green-100 p-4 rounded">
                                    <p class="text-sm">Ingresos</p>
                                    <p class="text-3xl font-bold">$${reservas.reduce((s, r) => s + (parseFloat(r.monto) || 0), 0).toFixed(0)}</p>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="font-bold mb-3">‚ûï Crear Proveedor</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    <input type="text" id="provNombre" placeholder="Nombre" class="p-2 border rounded">
                                    <input type="email" id="provEmail" placeholder="Email" class="p-2 border rounded">
                                    <button onclick="crearProveedor()" class="bg-blue-600 text-white rounded">Crear</button>
                                </div>
                            </div>

                            <h3 class="font-bold mb-3">üë• Proveedores</h3>
                            <div id="proveedoresTable"></div>
                        </div>
                    </div>
                </div>
            `;
            cargarReservasProveedor();
            actualizarTablaProveedores();
        }

        window.crearProveedor = async function() {
            const nombre = document.getElementById('provNombre').value.trim();
            const email = document.getElementById('provEmail').value.trim();

            if (!nombre || !email) {
                mostrarNotificacion('Completa los campos', 'error');
                return;
            }

            try {
                const codigo = generarCodigoProveedor();
                await addDoc(collection(db, 'proveedores'), {
                    nombre,
                    email,
                    codigo,
                    fechaCreacion: new Date()
                });
                mostrarNotificacion(`‚úÖ C√≥digo: ${codigo}`, 'success');
                document.getElementById('provNombre').value = '';
                document.getElementById('provEmail').value = '';
            } catch (error) {
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
        };

        function actualizarTablaProveedores() {
            const tbody = document.getElementById('proveedoresTable');
            if (!tbody) return;

            let html = `
                <div class="border rounded-lg overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">Nombre</th>
                                <th class="p-3 text-left">C√≥digo</th>
                                <th class="p-3 text-left">Email</th>
                                <th class="p-3 text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (proveedores.length === 0) {
                html += '<tr><td colspan="4" class="p-3 text-center text-gray-500">Sin proveedores</td></tr>';
            } else {
                proveedores.forEach(p => {
                    html += `
                        <tr class="border-t">
                            <td class="p-3">${p.nombre}</td>
                            <td class="p-3"><code class="bg-gray-100 px-2 py-1 rounded">${p.codigo}</code></td>
                            <td class="p-3">${p.email}</td>
                            <td class="p-3">
                                <button onclick="eliminarProveedor('${p.id}')" class="text-red-600">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            }

            html += '</tbody></table></div>';
            tbody.innerHTML = html;
        }

        window.eliminarProveedor = async function(id) {
            if (confirm('¬øEliminar proveedor?')) {
                try {
                    await deleteDoc(doc(db, 'proveedores', id));
                    mostrarNotificacion('‚úÖ Eliminado', 'success');
                } catch (error) {
                    mostrarNotificacion('Error: ' + error.message, 'error');
                }
            }
        };

        function mostrarNotificacion(msg, tipo) {
            // Simple alert
            if (tipo === 'success') {
                console.log('‚úÖ', msg);
            } else {
                console.error('‚ùå', msg);
            }
            alert(msg);
        }

        // Iniciar
        console.log('ProveApp cargada - Firebase conectado ‚úÖ');
        renderLogin();
    </script>
</body>
</html>
